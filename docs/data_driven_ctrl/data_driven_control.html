<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.361">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Khushant Khurana - Controlling Data Driven Systems Using System Identification and Model Reduction​</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-R5DWCF4Z6W"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-R5DWCF4Z6W', { 'anonymize_ip': true});
</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Khushant Khurana</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../resume_khurana.pdf" rel="" target="">
 <span class="menu-text">Resume</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../transcript.pdf" rel="" target="">
 <span class="menu-text">Transcript</span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item">Controlling Data Driven Systems Using System Identification and Model Reduction​</li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation docked overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text"><strong>Home</strong></span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">• Introduction</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text"><strong>Past internships</strong></span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
 <span class="menu-text">• Aviation Systems Engineering Intern @ Garmin</span>
  </li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../oshkosh_poster.pdf" class="sidebar-item-text sidebar-link">
 <span class="menu-text">• Controls Intern @ Oshkosh Corporation</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text"><strong>Projects</strong></span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../gnc.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">• Guidance Navigation &amp; Control</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../dynamics_control.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">• Dynamics &amp; Control</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../simulation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">• Simulation &amp; Analysis</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fabrication.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">• Mechanical Design &amp; Fabrication</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#a-brief-synopsis" id="toc-a-brief-synopsis" class="nav-link active" data-scroll-target="#a-brief-synopsis">A Brief Synopsis</a></li>
  <li><a href="#using-singular-value-decomposition-to-recreate-the-fluid-flow-over-an-airfoil" id="toc-using-singular-value-decomposition-to-recreate-the-fluid-flow-over-an-airfoil" class="nav-link" data-scroll-target="#using-singular-value-decomposition-to-recreate-the-fluid-flow-over-an-airfoil">1. Using Singular Value Decomposition to recreate the fluid flow over an airfoil!</a></li>
  <li><a href="#using-dynamic-mode-decomposition-to-recreate-the-fluid-flow-over-an-airfoil" id="toc-using-dynamic-mode-decomposition-to-recreate-the-fluid-flow-over-an-airfoil" class="nav-link" data-scroll-target="#using-dynamic-mode-decomposition-to-recreate-the-fluid-flow-over-an-airfoil">2. Using Dynamic Mode Decomposition to recreate the fluid flow over an airfoil!</a></li>
  <li><a href="#using-sparse-identification-of-non-linear-dynamics-sindy-to-reconstruct-mass-spring-damper-model." id="toc-using-sparse-identification-of-non-linear-dynamics-sindy-to-reconstruct-mass-spring-damper-model." class="nav-link" data-scroll-target="#using-sparse-identification-of-non-linear-dynamics-sindy-to-reconstruct-mass-spring-damper-model.">3. Using Sparse Identification of Non-Linear Dynamics (Sindy) to reconstruct mass-spring-damper model.</a></li>
  <li><a href="#eigensystem-realization-algorithm-era" id="toc-eigensystem-realization-algorithm-era" class="nav-link" data-scroll-target="#eigensystem-realization-algorithm-era">4. Eigensystem Realization Algorithm (ERA)</a></li>
  <li><a href="#supporting-files" id="toc-supporting-files" class="nav-link" data-scroll-target="#supporting-files">5. Supporting files</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content column-body" id="quarto-document-content">



<div class="quarto-about-jolla column-body">
  <img src="data_driven_ctrl.png" class="about-image
  rectangle " style="width: 30em;">
 <header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Controlling Data Driven Systems Using System Identification and Model Reduction​</h1>
</div>
<div class="quarto-title-meta">
  </div>
</header><div id="heading">
</div>  
</div>

<section id="a-brief-synopsis" class="level2">
<h2 data-anchor-id="a-brief-synopsis">A Brief Synopsis</h2>
<p>Under this project, data driven numerical methods are used to perform system identification and model reduction. The data sets used are subjected to basic linear algebra techniques such as Principle Component Analysis (PCA) and Singular Value Decomposition (SVD) for model reduction. This is followed by system id using methods such as Dynamic Mode Decomposition (DMD), Eigenanalysis Realization Algorithm (ERA), and Sparse Identification of Non Linear Dynamics (Sindy) to generate linear models for non-linear systems. Since the main goal is to design controllers for these systems, linear systems allow to construct controllers such as Linear Quadratic Controller (LQR) and Model Predictive Control (MPC). The datasets used consists of Flow over Airfoils, Flight Dynamics Datasets, and basic systems such as mass spring and inverted pendulum.</p>
</section>
<section id="using-singular-value-decomposition-to-recreate-the-fluid-flow-over-an-airfoil" class="level2">
<h2 data-anchor-id="using-singular-value-decomposition-to-recreate-the-fluid-flow-over-an-airfoil">1. Using Singular Value Decomposition to recreate the fluid flow over an airfoil!</h2>
<p>In order to understand the significance of Singular Value Decomposition, especially in the field of compression, a big dataset of flow velocities found <a href="http://deepblue.lib.umich.edu/data/collections/kk91fk98z">here</a> is subjected to the algorithm. Specifically, the dataset for airfoil with angle of attack of 25 degrees and frequency of 0.05 hz is used. The dataset itself (for both X and Y velocity) comes in a 3-D matrix, where the first two dimensions represent the velocity for individual snapshots in time. Accordingly, the third dimension contains the number of snapshots, which are 400 in total. Before performing SVD on the dataset, pre-processing is done in the following format:</p>
<ul>
<li>The 2-D grid of velocities is shaped into a single column vector.</li>
<li>Individual snapshots are then horizontally stacked as column vectors. Accordingly, the final product is a big 2-D matrix where columns are snapshots of velocities at consecutive times.</li>
<li>The 2-D grid of X and Y velocity is stacked vertically to make the analysis less repetetive.</li>
<li>The mean of every column is subtracted, serving the purpose of normalizing the data.</li>
</ul>
<p>Finally, the data is ready to be subjected to an economy SVD and the following matrices are derived: U, S, V. The matrix U contains information about the spatial modes while the product of S and V’ contains information about the temporal ampltiude of the corresponding modes in U. As expected, SVD figures out which pattern in the data summarizes it the best. A graphic of the eigenvalues (square of the singular values of the data) is show below.</p>
<p><img src="svd_eigenvalues.png" class="img-fluid"></p>
<p>The first 6 spatial modes which are basically the first 6 column vectors of U are shown below as well. Since the big data matrix contains both x and y velocities, it is important to remember that the top half of the matrix contains the x velocity and bottom half contains the y velocity.<br>
<img src="svd_ux_modes.png" class="img-fluid"></p>
<p><img src="svd_uy_modes.png" class="img-fluid"></p>
<p>The corresponding temporal amplitude for these modes is also shown below. As seen, the first 2 dominant modes follow a cyclic wave which are at an offset of a quarter wave.</p>
<p><img src="svd_temporal_amps.png" class="img-fluid"></p>
<p>Finally, the construction of the flows is performed by choosing a certain number of columns (&lt;400). The mean subtracted from individual columns is added back to the columns selected for reconstruction and the columns are also shaped back to the grid format. By choosing which snapshot to view, a contour plot can be generated, as shown below for first snapshot or t = 1 sec.&nbsp;</p>
<p><img src="svd_uy_recons.png" class="img-fluid"></p>
<p>Following is the video of the reconstruction of the flows can be found in the files attached in the repository. <video src="FluidFlowReconstruction_SVD.mp4" class="img-fluid" controls=""><a href="FluidFlowReconstruction_SVD.mp4">Video</a></video></p>
</section>
<section id="using-dynamic-mode-decomposition-to-recreate-the-fluid-flow-over-an-airfoil" class="level2">
<h2 data-anchor-id="using-dynamic-mode-decomposition-to-recreate-the-fluid-flow-over-an-airfoil">2. Using Dynamic Mode Decomposition to recreate the fluid flow over an airfoil!</h2>
<p>Dynamic mode decomposition tries to find the best fit “linear operator” which can predict the next state of the system. Consider ‘X’ to be the state of the system at time t=k and “X’” to be the state at k+1, then DMD finds the A that can satsify the equations listed below. By taking the inverse of X’, A can be determined.</p>
<p><span class="math display">\[
X' = A * X
\]</span></p>
<p><span class="math display">\[
A = X' * X^{-1}
\]</span></p>
<p>Since the matrix X is not always square, Singular Value Decomposition from above is used to find the pseudo-inverse. Equations below show expansion of the matrix X based on SVD and its inverse in terms of the individual matrix. Another important characteristic about DMD is that it finds a matrix called A tilda which is much smaller in size as compared to the original A but has the same eigenvalues. This decreases the computation cost by a lot.</p>
<p><span class="math display">\[
X = U * \Sigma * V*
\]</span></p>
<p><span class="math display">\[
X' = A * U * \Sigma * V*
\]</span></p>
<p><span class="math display">\[
A\sim = U * X' * V * \Sigma^{-1} = U* * A * U
\]</span></p>
<p>Once A tilda is know, its eigenvalues (W) can be calculated which are same as A and then the eigenvectors of A which are labelled as phi can be determined through back calculation using lambda.</p>
<p><span class="math display">\[
A\sim * \lambda = \lambda * W
\]</span></p>
<p><span class="math display">\[
\phi = X' * V * \Sigma^{-1} * \lambda
\]</span></p>
<p>To perform a DMD on the same flow field, the velocities are stacked in a similar format as before to make the X matrix and the first column is deleted to make X’. The airfoil data used for this has an angle of attack of 25 degrees with freq of 0.05 Hz. Subjecting to DMD analysis, the amplitudes of the modes are derived and the plot is listed below: <img src="dmd_freq.png" class="img-fluid"></p>
<p>Also, the contour plot for the first 4 modes along with their frequency is given below: <img src="dmd_modes.png" class="img-fluid"></p>
<p>Finally, the reconstruction of the fluid flow is performed using the DMD Algorithm and the following the comparison: Following is the video of the fluid reconstruction using DMD and first 20 POD modes. <video src="FluidFlowReconstruction_DMD.mp4" class="img-fluid" controls=""><a href="FluidFlowReconstruction_DMD.mp4">Video</a></video></p>
</section>
<section id="using-sparse-identification-of-non-linear-dynamics-sindy-to-reconstruct-mass-spring-damper-model." class="level2">
<h2 data-anchor-id="using-sparse-identification-of-non-linear-dynamics-sindy-to-reconstruct-mass-spring-damper-model.">3. Using Sparse Identification of Non-Linear Dynamics (Sindy) to reconstruct mass-spring-damper model.</h2>
<p>Sindy is a sparse identification technique to derive a linear combination of basis functions and reconstruct the data field. A simple mass-spring-damper system is subjected to Sindy and the spring and damper stiffness are back calculated from the coefficients given through Sindy. The parameters used are given below: k = 10 N/m, b = 20 N/(m^2 sec), and m = 1 kg. The original differential equation is stated as follows. Moreover, a sinusoidal force is applied to the system and the position and velocity are recorded.</p>
<p><span class="math display">\[
\ddot(x) = \frac{F(t)}{m} - b\dot(x) - kx
\]</span></p>
<p>The data collected is subjected to Sindy and the sparsification know is adjusted to get the correct sparse model. The basis functions used are: {1, x, x_dot, u, x^2, x_dot^2, u^2}. The results of this tuning are given below. Using lambda = 0.01, the following coefficients are determined.</p>
<p><img src="mass_spring_sindy.png" class="img-fluid"></p>
<p><img src="mass_spring_sindy_coeff.png" class="img-fluid"></p>
</section>
<section id="eigensystem-realization-algorithm-era" class="level2">
<h2 data-anchor-id="eigensystem-realization-algorithm-era">4. Eigensystem Realization Algorithm (ERA)</h2>
<p>ERA is a data based analysis of a system which is capable of determining the discrete state space matrices: A, B, &amp; C using the impulse response. Accordingly, the the system can be described as follows:</p>
<p><span class="math display">\[
x_\text{k+1} = A_d x_k + B_d u_k
\]</span></p>
<p><span class="math display">\[
y_k = C_d x_k
\]</span></p>
<p><span class="math display">\[
u_k = \delta(t)
\]</span></p>
<p>By writing out the response of the system with initial conditions to be 0, the output can be characteristed by</p>
<p><span class="math display">\[
y_k = C_d A_d ^ {k-1}B_d
\]</span></p>
<p>Following this the Henkel matrices -H and H’ - are generated and the SVD is taken to convert the model from high to low dimensional model. A, B, and C matrices are generated using the following:</p>
<p><span class="math display">\[
SVD(H) = U \sigma V^{*}
\]</span></p>
<p><span class="math display">\[
A = \sigma^{-.5} U^{T} H' V \sigma^{.5}
\]</span></p>
<p><span class="math display">\[
B = \sigma^{.5} U^{T} H
\]</span></p>
<p><span class="math display">\[
C = H V \sigma^{.5}
\]</span></p>
<p>To understand this approximation, ERA is tried on the transfer function decribing the Atomic Force Microscope. The corresponding transfer function is given below:</p>
<p><span class="math display">\[
G = \frac{kw_2^2w_3^2w_5^2(s^2+2\zeta_1w_1s+w1^2)(s^2+2\zeta_4w_4s+w_4^2)exp(-s\tau)}{w_1^2w_4^2(s^2 + 2\zeta_2w_2s + w_2^2)(s^2 + 2\zeta_3w_3s + w_3^2)(s^2 + 2\zeta_5w_5s + w_5^2)}
\]</span></p>
<p>The impulse response of the system is determined (also shown below) and hankel matrices are generated. <img src="era_impulse.png" class="img-fluid"></p>
<p>After determining the discrete A,B,C matrices, the bode plots are generated from the ERA esimtation and actual transfer function. The results are shown below. <img src="era_result.png" class="img-fluid"></p>
<p>To see the effects of the addition of the white to the system, random normal gaussian noise is added to the impulse response and subjected to the ERA estimation. Surprisingly, the noise does not decrease the accuracy of the estimation; only does at high frequency. This makes sense because by taking SVD of the hankel matrix, the low energy pod modes are neglected which contain the noise. The results of the addition of white noise to the system are shown below:</p>
<p><img src="era_result_noise1.png" class="img-fluid"></p>
<p><img src="era_result_noise2.png" class="img-fluid"></p>
</section>
<section id="supporting-files" class="level2">
<h2 data-anchor-id="supporting-files">5. Supporting files</h2>
<p>To access the code, check out the <a href="https://github.com/khushant2001/Data_driven_control">github</a></p>



</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">Copyright 2023, Khushant Khurana</div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>



</body></html>